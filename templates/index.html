<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Chat IA Flask em tempo real</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Tailwind via CDN (for development) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* garantir que o background preencha toda a tela */
        html, body { height: 100%; }
        /* fixar o background para evitar 'brancos' ao rolar */
        body { background-attachment: fixed; }
        /* Estilizar a scrollbar do chat */
        #messages::-webkit-scrollbar { width: 10px; }
        #messages::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 10px; }
        #messages::-webkit-scrollbar-thumb { background: rgba(124,58,237,0.6); border-radius: 10px; }
        /* Firefox */
        #messages { scrollbar-width: thin; scrollbar-color: rgba(124,58,237,0.6) rgba(255,255,255,0.02); }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-indigo-900 via-purple-900 to-pink-900 bg-fixed">
    <div class="min-h-screen flex items-start justify-center">
        <div class="w-full max-w-3xl flex flex-col h-screen">
            <div class="flex items-center justify-between p-4">
                <h1 class="text-xl font-semibold text-white">Chat IA</h1>
                <div id="status" class="text-sm text-slate-400">Conectando...</div>
            </div>

            <div class="flex-1 p-4 pb-24">
                <div class="bg-slate-800 rounded-2xl shadow-xl p-4 h-full flex flex-col border border-slate-700">
                    <div id="messages" aria-live="polite" class="flex-1 overflow-y-auto p-2 pb-6 md:pb-2 space-y-3 bg-slate-800 rounded-lg">
                        <div id="empty-state" class="w-full h-full flex items-center justify-center text-center text-slate-400 px-6">
                            <div>
                                <p class="text-lg font-medium">Envie sua mensagem, mas cuidado!</p>
                                <p class="mt-2 text-sm">O Cuidado: as respostas nem sempre são as que esperamos, verifique e confirme antes de agir.</p>
                                <p class="mt-2 text-sm">Este modelo pode ser mal-educado, principalmente se não gostar de você. Não há viés do criadores aqui.</p>
                                <p class="mt-2 text-sm">Se quiser falar sobre Valorant, você pode escrever Valorant ou Escolher no Menu Ativar Chat VLR.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- input fixo tipo WhatsApp em telas pequenas (mobile-first) -->
            <div id="input-bar" class="fixed bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-slate-950/90 backdrop-blur-md" style="padding-bottom: env(safe-area-inset-bottom);">
                <div class="max-w-3xl mx-auto">
                    <form id="chat-form" class="flex gap-3 pb-3 items-end">
                        <textarea id="user-input" rows="1" autocomplete="off" placeholder="Digite sua mensagem..." required class="flex-1 resize-none bg-slate-900 border border-slate-700 rounded-full px-4 py-3 text-slate-100 placeholder:text-slate-500 h-16 max-h-56"></textarea>
                               <div class="flex items-center gap-3">
                                   <!-- action menu button -->
                                   <div class="relative">
                                       <button id="action-btn" type="button" class="bg-slate-700 hover:bg-slate-600 text-white w-10 h-10 rounded-full flex items-center justify-center" aria-expanded="false" aria-haspopup="true">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                       </button>
                                       <div id="action-menu" class="hidden absolute right-0 mb-2 bottom-full w-40 bg-slate-800 border border-slate-700 rounded-lg shadow-lg z-50">
                                           <button id="activate-valorant" class="w-full text-left text-white px-4 py-2 hover:bg-slate-700">Ativar Chat VLR</button>
                                           <button id="leave-valorant" class="w-full text-left px-4 text-white py-2 hover:bg-slate-700">Sair</button>
                                           <button id="professor-gone" class="w-full text-left px-4 text-white py-2 hover:bg-slate-700">O Professor foi embora</button>
                                       </div>
                                   </div>

                                   <button id="send-btn" type="submit" class="flex items-center justify-center bg-violet-600 hover:bg-violet-500 text-white font-semibold w-14 h-14 rounded-full">
                                       <!-- ícone de enviar (paper plane) -->
                                       <svg id="send-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M2 21l21-9L2 3v7l15 2-15 2z" /></svg>
                                   </button>
                               </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        const socket = io();
        const form = document.getElementById('chat-form');
        const messagesDiv = document.getElementById('messages');
        const statusDiv = document.getElementById('status');
        const inputEl = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const originalSendHTML = sendBtn.innerHTML;

        let isStreaming = false;
        let partialBotDiv = null;

        function setStreaming(on){
            isStreaming = on;
            inputEl.disabled = on;
            sendBtn.disabled = on;
            if(on){
                statusDiv.textContent = 'Assistente respondendo...';
                inputEl.classList.add('opacity-60');
                // show spinner + text
                sendBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg><span>Respondendo...</span>`;
            } else {
                statusDiv.textContent = 'Pronto';
                inputEl.classList.remove('opacity-60');
                sendBtn.innerHTML = originalSendHTML;
            }
        }

    socket.on('connect', () => { statusDiv.textContent = 'Conectado'; adjustMessagesPadding(); });
    socket.on('disconnect', () => { statusDiv.textContent = 'Desconectado'; });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const msg = inputEl.value.trim();
            if (!msg || isStreaming) return;
            appendMessage(msg, 'user');
            // ocultar estado vazio quando houver mensagens
            const empty = document.getElementById('empty-state'); if(empty) empty.style.display = 'none';
            socket.emit('message', msg);
            inputEl.value = '';
            inputEl.style.height = 'auto';

            // bloquear input até 'stream_end'
            setStreaming(true);
            const empty2 = document.getElementById('empty-state'); if(empty2) empty2.style.display = 'none';
            partialBotDiv = appendMessage('', 'bot');
        });

        // Send on Enter, Shift+Enter for newline
        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.requestSubmit();
            }
        });

        // auto-resize textarea
        inputEl.addEventListener('input', () => {
            inputEl.style.height = 'auto';
            inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
        });

        socket.on('message', function(msg){
            if (typeof msg !== 'string') msg = JSON.stringify(msg);

            // messages that start with a newline are special (tool_call)
            if (msg.startsWith('\n')){
                appendMessage(msg.trim(), 'bot');
                return;
            }

            // append incrementally
            if (partialBotDiv) {
                partialBotDiv.textContent += msg;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } else {
                appendMessage(msg, 'bot');
            }
        });

        // stream end
        socket.on('stream_end', function(){
            partialBotDiv = null;
            setStreaming(false);
            // garantir scroll final quando stream terminar
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // scroll ao focar (útil em mobile quando o teclado abre)
        inputEl.addEventListener('focus', () => {
            setTimeout(() => { messagesDiv.scrollTop = messagesDiv.scrollHeight; }, 250);
            adjustMessagesPadding();
        });

        // rolagem sempre que a janela muda de tamanho (teclado virtual abrindo/fechando)
        window.addEventListener('resize', () => { adjustMessagesPadding(); messagesDiv.scrollTop = messagesDiv.scrollHeight; });

        // ajustar padding-bottom do container de mensagens para caber a barra de input fixa
        function adjustMessagesPadding(){
            const inputBar = document.getElementById('input-bar');
            if(!inputBar) return;
            const rect = inputBar.getBoundingClientRect();
            const pb = Math.max(rect.height + 8, 80); // mínimo
            messagesDiv.style.paddingBottom = pb + 'px';
        }

        function appendMessage(text, who='bot') {
            const empty = document.getElementById('empty-state'); if(empty) empty.style.display = 'none';
            const wrapper = document.createElement('div');
            wrapper.className = who === 'user' ? 'flex justify-end' : 'flex justify-start';

            const container = document.createElement('div');
            container.className = 'flex flex-col max-w-[85%]';

            const bubble = document.createElement('div');
            bubble.className = who === 'user' ? 'bg-emerald-400 text-emerald-900 px-4 py-2 rounded-2xl whitespace-pre-wrap' : 'bg-slate-700 text-slate-100 px-4 py-2 rounded-2xl whitespace-pre-wrap';
            bubble.textContent = text;

            const meta = document.createElement('div');
            meta.className = 'text-xs text-slate-400 mt-1 self-end';
            meta.textContent = new Date().toLocaleTimeString();

            container.appendChild(bubble);
            container.appendChild(meta);
            wrapper.appendChild(container);
            messagesDiv.appendChild(wrapper);
            // scroll para a mensagem recém adicionada (centraliza no mobile)
            wrapper.scrollIntoView({behavior: 'smooth', block: 'center'});
            return bubble;
        }

        // Action menu: toggle and handlers for Valorant/Leave
        const actionBtn = document.getElementById('action-btn');
        const actionMenu = document.getElementById('action-menu');
    const activateBtn = document.getElementById('activate-valorant');
    const leaveBtn = document.getElementById('leave-valorant');
    const professorGoneBtn = document.getElementById('professor-gone');

        actionBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = actionMenu.classList.contains('hidden');
            if (isHidden) actionMenu.classList.remove('hidden'); else actionMenu.classList.add('hidden');
        });

        // close menu on outside click
        document.addEventListener('click', () => { actionMenu.classList.add('hidden'); });

        activateBtn.addEventListener('click', (e) => {
            e.preventDefault();
            actionMenu.classList.add('hidden');
            // Emit the command 'Valorant' to the server
            socket.emit('message', 'Valorant');
            // show a small confirmation bubble locally as user action
            appendMessage('Ativando Valorant...', 'user');
            // ensure client unblocks quickly if server handles locally (server emits stream_end)
            setStreaming(true);
        });

        leaveBtn.addEventListener('click', (e) => {
            e.preventDefault();
            actionMenu.classList.add('hidden');
            socket.emit('message', 'sair');
            appendMessage('Saindo do modo Valorant...', 'user');
            setStreaming(true);
        });

        professorGoneBtn.addEventListener('click', (e) => {
            e.preventDefault();
            actionMenu.classList.add('hidden');
            // envia a frase exata que desativa o modo Professor no servidor
            socket.emit('message', 'O Professor foi embora');
            appendMessage('O Professor foi embora', 'user');
            setStreaming(true);
        });
    </script>
</body>
</html>